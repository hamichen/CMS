tinymce.PluginManager.add("imglist",function(t){function e(){var e=new Array;$("#filelisted").find(">li").each(function(){var t=String($(this).find(">a").text()),i=new RegExp(".jpg|.png|.gif","i");t.match(i)&&e.push({id:this.id,text:t.slice(0,t.indexOf("(")).trim()})});var i,n,s=7,l=e.length,o=Math.ceil(e.length/s),c='<div style="margin: 10px;"><table id="myImgTable" class="mygallery"><tbody>',a=0;for(y=0;o>y;y++){for(c+="<tr>",x=0;s>x;x++)a=y*s+x,l>a?(n=e[a].id,c+='<td style="text-align: center;"><div style="text-align: center;height: 25px;"><img src="/images/icon/ok.png" /></div>',c+='<div style="text-align: center;"><img id="'+n+'" class="is_select" src="/open-news/news/show-file/'+n+'.jpg?thumb=100,75" />',c+='<br /><span style="font-size: 10px;">'+e[a].text+"</span></div></td>"):c+="<td></td>";c+="</tr>"}c+="</tbody></table></div>";var r={type:"container",html:c,onclick:function(t){var e=$(t.target);e.is("img")&&"/images/icon/ok.png"!=e.attr("src")&&(e.hasClass("is_select")?(e.removeClass("is_select"),e.parent().prev().find("img").remove()):(e.addClass("is_select"),e.parent().prev().html('<img src="/images/icon/ok.png" />')))}};i=t.windowManager.open({title:"請選擇要插入的圖片",width:800,height:130*o+50,resizable:"yes",inline:"yes",items:[r],buttons:[{text:"全選",onclick:function(){$("#myImgTable").find("img").each(function(){"/images/icon/ok.png"!=$(this).attr("src")&&$(this).addClass("is_select").parent().prev().html('<img src="/images/icon/ok.png" />')})}},{text:"取消全選",onclick:function(){$("#myImgTable").find("img.is_select").each(function(){$(this).removeClass("is_select").parent().prev().find("img").remove()})}},{text:"確定",onclick:function(){var e=0,n='<div><ul class="mygallery-container">';$("#myImgTable").find("img.is_select").each(function(){n+="<li>",n+='<a href="/open-news/news/show-file/'+this.id+'.jpg" data-lightbox="photoView">',n+='<img src="/open-news/news/show-file/'+this.id+'.jpg?thumb=100,75" alt="img" />',n+="</a>",n+="</li>",e+=1}),e>0?(n+='</ul></div><div style="clear: left;"></div>',t.insertContent(n),i.close()):alert("未選取任何圖片")}},{text:"取消",onclick:function(){i.close()}}]})}function i(){t.setContent(t.getContent()+"<p></p>"),t.selection.select(t.getBody(),!0),t.selection.collapse(!1)}function n(){t.setContent("<p></p>"+t.getContent())}t.addButton("imglist",{icon:"picture-o",tooltip:"插入圖片列表",onclick:e}),t.addButton("addHP",{icon:"plus-square-o",tooltip:"在最前方插入新段落(<p></p>)",onclick:n}),t.addButton("addP",{icon:"square-o",tooltip:"在最下方插入新段落(<p></p>)",onclick:i})});