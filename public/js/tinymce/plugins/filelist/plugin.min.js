tinymce.PluginManager.add("filelist",function(t){function e(){n(!1)}function i(){n(!0)}function n(e){var i=new Array;$("#filelisted").find(">li").each(function(){var t=String($(this).find(">a").text()),e=t.indexOf("(");-1!=e&&(t=t.slice(0,e).trim());var n="default",s=new RegExp(".jpg|.png|.gif","i");if(t.match(s))n="img";else{var l=t.lastIndexOf(".");-1!=l&&(n=t.substr(l+1,t.length))}i.push({id:this.id,type:n,text:t})});var n,s,l,a=7,c=i.length,o=Math.ceil(i.length/a),r='<div style="margin: 10px;"><table id="myImgTable" class="mygallery"><tbody>',g=0;for(y=0;o>y;y++){for(r+="<tr>",x=0;a>x;x++)g=y*a+x,c>g?(s=i[g].id,l=i[g].type,"img"==l?(r+='<td style="text-align: center;"><div style="text-align: center;height: 25px;"></div>',r+='<div style="text-align: center;"><img id="'+s+'" src="/open-news/news/show-file/'+s+'.jpg?thumb=40,34" />'):(r+='<td style="text-align: center;"><div style="text-align: center;height: 25px;"></div>',r+='<div style="text-align: center;"><img id="'+s+'" src="/images/icon/'+l+'.jpg" />'),r+='<br /><span style="font-size: 10px;">'+i[g].text+"</span></div></td>"):r+="<td></td>";r+="</tr>"}r+="</tbody></table></div>";var d={type:"container",html:r,onclick:function(t){var e=$(t.target);e.is("img")&&"/images/icon/ok.png"!=e.attr("src")&&(e.hasClass("is_select")?(e.removeClass("is_select"),e.parent().prev().find("img").remove()):(e.addClass("is_select"),e.parent().prev().html('<img src="/images/icon/ok.png" />')))}};n=t.windowManager.open({title:"請選擇要製作成列表的檔案",width:800,height:130*o+50,resizable:"yes",inline:"yes",items:[d],buttons:[{text:"全選",onclick:function(){$("#myImgTable").find("img").each(function(){"/images/icon/ok.png"!=$(this).attr("src")&&$(this).addClass("is_select").parent().prev().html('<img src="/images/icon/ok.png" />')})}},{text:"取消全選",onclick:function(){$("#myImgTable").find("img.is_select").each(function(){$(this).removeClass("is_select").parent().prev().find("img").remove()})}},{text:"確定",onclick:function(){var i=0,s='<div><ul class="list-group">';$("#myImgTable").find("img.is_select").each(function(){s+='<li style="padding:5px 8px;" class="list-group-item">',s+=e?'<a href="/open-news/news/showimg/'+this.id+'" target="blank">':'<a href="/open-news/news/get-file/'+this.id+'">',s+=$(this).parent().find(">span").text()+"</a>",s+="</li>",i+=1}),i>0?(s+="</ul></div><p> </p>",t.insertContent(s),n.close()):alert("尚未選取任何檔案")}},{text:"取消",onclick:function(){n.close()}}]})}t.addButton("filelist",{icon:"list-alt",tooltip:"插入檔案下載列表",onclick:e}),t.addButton("filelistBlank",{icon:"list",tooltip:"插入檔案列表(新視窗開啟)",onclick:i})});