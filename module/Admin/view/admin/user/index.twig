{% extends 'layout/layout.twig' %}
{% block content %}
    <div id="forms" class="panel panel-default">

        <div class="panel-heading">
            <div class="pull-right"><span class="btn btn-primary btn-edit">新增使用者</span> </div>
            <h3>使用者列表</h3>

        </div>

        <div class="panel-body">
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>登入帳號</th>
                    <th>顯示名稱</th>
                    <th>角色</th>
                    <th>編修</th>
                </tr>
                </thead>
                <tbody>
                {% for v in data %}
                    <tr id="tr-{{ v.id }}">
                        <td>{{ v.username }}</td>
                        <td>{{ v.display_name }}</td>
                        <td>{{ roleArr[v.role]}}</td>
                        <td>
                            <span class="btn btn-primary btn-xs btn-edit">修改 </span>
                            <span class="btn btn-warning btn-xs btn-delete">刪除 </span>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

        </div>
    </div>
{% endblock %}

{% block style %}
    <link href="{{basePath}}/css/bootstrap-dialog.min.css" rel="stylesheet" >
{% endblock %}

{% block inline %}
    <script src="{{ basePath }}/js/bootstrap-dialog.min.js"></script>
    <script type="text/javascript">
        $(function(){
            $(".btn-edit").click(function(){
                if ($(this).text() == '新增使用者') {
                    var url = '{{ url('admin/default',{controller:'user', action:'edit'}) }}';
                }
                else {
                    var id = $(this).parents('tr').attr('id').substr(3);
                    var url = '{{ url('admin/default',{controller:'user', action:'edit'}) }}?id='+id;
                }

                BootstrapDialog.show({
                    title: '使用者編修',
                    message: $('<div></div>').load(url),
                    buttons: [{
                        label: '確定',
                        icon: 'glyphicon glyphicon-ok',
                        cssClass: 'btn-primary',
                        action: function(dialogItself) {
                            var data = $("#userForm").serialize();
                            var url = '{{ url('admin/default', {controller:'user', action:'save'}) }}';
                            $.post(url, data, function(res){
                                if (res.success) {
                                    window.location.reload();
                                }
                                else {
                                    $.each(res.message, function(i,v){
                                        $("input[name='"+i+"']").addClass('alert-danger');
                                    });

                                }

                            });

                        }
                    }, {
                        label: '取消',
                        action: function(dialogItself) {
                            dialogItself.close();
                        }
                    }]
                });
            });

            $(".btn-delete").click(function(){
                var id = $(this).parents('tr').attr('id').substr(3);
                BootstrapDialog.show({
                    title: '對話框',
                    message: '確定刪除?',
                    buttons: [{
                        label: '確定',
                        cssClass: 'btn-warning',
                        action: function(dialogItself) {
                            var url = '{{ url('admin/default', {controller:'user', action:'delete'}) }}';
                            $.get(url, {id:id}, function(res){
                                if (res.success) {
                                    window.location.reload();
                                }
                                else {
                                    BootstrapDialog.alert(res.message);
                                }

                            });

                        }
                    }, {
                        label: '取消',
                        action: function(dialogItself) {
                            dialogItself.close();
                        }
                    }]
                });
            });
        });
    </script>
{% endblock %}